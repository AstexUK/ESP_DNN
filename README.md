# Graph-convolutional DNN for predicting ESP surfaces

This repository contains the code to generate [PQR files](https://apbs-pdb2pqr.readthedocs.io/en/latest/formats/pqr.html)
for ligands and proteins that can be used to generate high quality ESP surfaces.
The PQR files records partial charge and radii in the PDB occupancy and b-factor
columns. PQR files generated by our models conatains charges on atoms as well as
off-centered charges on atomic features (e.g., lone pairs, sigma holes, p
orbitals).
For generating ligand PQR files, a graph convolutional deep neural network (DNN)
model, trained on ESP surfaces derived using high quality QM calculations, is 
used. For proteins, parametized charges for all amino acids are used, which are
fully compatible with the ligand ESP surfaces generated using the DNN model.


# How to install
To run our ESP model, you need to:
* Clone this repository
* setup Python and third-party dependencies listed below.
* (optionally) install this package.
* Install [PLI code](https://bitbucket.org/AstexUK/pli/src/pli-snapshot/)
* Set up PLI_DIR environment variable

## Cloning this repository
See Clone button for information

## Installing Python and third-party requirements:
Our package works on Python 2.7 and require following third-party packages:
* rdkit==2018.09.3
* keras==2.2.4
* tensorflow==1.10.0
* numpy==1.16.2

We recommend using [Anaconda Python distribution](https://www.anaconda.com/distribution/)
for installing Python and the above
dependencies. Clone this repository and run the following commands:

```
conda env create -f environment.yml
source activate esp_ai
```

## (Optionally installing this package)
If you want to be able to run this package from any directory, you need to
install this package. Otherwise, you should be able to run this package from the
parent directory of this package. If you cloned the repository in /home/username
directory, then you need to ```cd /home/username``` before running the program.
```bash
conda activate ESPAI
cd {REPOSITORY_DIRECTORY}
python setup.py
```

## Installing PLI code
```bash
git clone xxx.git
cd PLI
make pli
```

## Set up PLI_DIR environment variable
You need set PLI_DIR environment variable with the top level PLI directory of
the PLI repository just cloned 
### on csh
```csh
setenv PLI_DIR {PLI_DIR}
```
### on bash
```bash
export PLI_DIR={PLI_DIR}
```
Note: replace {PLI_DIR} with the directory you cloned PLI repository into.


# Example runs
To see the help on how to run the program run:
```bash
python -m ESPAI.predict -h
```

This package contains example ligand and protein PDB files in the example
directory. The output PQR files for each ligand and protein, which should be
generated are also provided in the same directory for comparison.

### Running prediction on ligand files:
```bash
python -m ESPAI.predict -m ligand -i examples/ligands
```

### Running prediction on protein files:
```bash
python -m ESPAI.predict -m protein -i examples/proteins
```

Compare the PQR files generated using the above commands with the corrsponding
*.saved files that were shipped with this package.

# Visualizing ESP surfaces
We recommend using [NGL viewer](http://nglviewer.org/ngl/)
* Open the PQR file using File menu
* Add a surface reprentation using menu button on the side bar on the right
* On the surface menu, set:
    * surfaceType = av
    * radiusType = explicit
    * colorScheme = electrostatic


